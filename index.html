<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storyboard Utility - Advanced Scenes & Slideshow v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .scene-block {
        background-color: #fff;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .scene-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .scene-title-input {
        font-size: 1.25rem;
        font-weight: 600;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        flex-grow: 1;
        min-width: 200px;
      }
      .scene-actions button, .scene-notes-button {
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.4rem 0.8rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
        white-space: nowrap;
      }
      .scene-notes-button { background-color: #6366f1; color: white; }
      .scene-notes-button:hover { background-color: #4f46e5; }
      .scene-notes-button.has-notes { background-color: #818cf8; }
      .scene-move-button { background-color: #a5b4fc; color: #3730a3; }
      .scene-move-button:hover { background-color: #818cf8; }
      .scene-move-button:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
      .delete-scene-button { background-color: #ef4444; color: white; }
      .delete-scene-button:hover { background-color: #dc2626; }

      .scene-image-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
      }
       @media (min-width: 640px) { .scene-image-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } }

      .empty-scene-image-grid {
        min-height: 150px; 
        border: 2px dashed #d1d5db; 
        background-color: #f9fafb; 
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
      }
      .empty-scene-image-grid.sortable-ghost-target::after {
        content: 'Drop image here';
        color: #6b7280; 
        font-size: 0.875rem;
      }


      .image-item {
        position: relative; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        overflow: hidden; cursor: grab; break-inside: avoid-column; background-color: #e5e7eb;
        transition: border-color 0.3s ease; border: 2px solid transparent;
      }
      .image-item.is-animated { border-color: #34d399; }
      .image-item.aspect-square { aspect-ratio: 1 / 1; }
      .image-item:active { cursor: grabbing; }
      .image-overlay-bottom { position: absolute; bottom: 0.5rem; left: 0.5rem; display: flex; align-items: center; gap: 0.25rem; z-index: 10; pointer-events: none; }
      .image-index { background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 0.75rem; font-weight: bold; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
      .image-index-duplicate { background-color: #fef08a; color: #dc2626 !important; }
      .duplicate-tag { background-color: #fef08a; color: #dc2626; font-size: 0.65rem; font-weight: bold; padding: 0.125rem 0.375rem; border-radius: 0.25rem; text-transform: uppercase; }
      .remove-button { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 9999px; width: 1.5rem; height: 1.5rem; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 11; pointer-events: auto; }
      .remove-button:hover { background-color: rgba(220, 38, 38, 0.8); }
      .remove-button svg { width: 0.875rem; height: 0.875rem; stroke-width: 2.5; }
      .image-item img { display: block; width: 100%; height: 100%; object-fit: contain; border-radius: 0.375rem; }
      .image-item.aspect-square img { object-fit: cover; }
      
      .image-action-button { 
        background-color: rgba(0,0,0,0.7); color: #e0e7ff; 
        border: 1px solid transparent; border-radius: 0.25rem;
        width: 1.25rem; height: 1.25rem; display: flex; justify-content: center; align-items: center;
        cursor: pointer; z-index: 10; pointer-events: auto; transition: background-color 0.2s, color 0.2s;
      }
      .image-action-button:hover { background-color: rgba(50,50,50,0.9); color: white; }
      .image-action-button svg { width: 0.75rem; height: 0.75rem; stroke-width: 2; }

      .animated-checkbox-label {
        display: flex; align-items: center; cursor: pointer; pointer-events: auto;
        padding: 0.1rem 0.2rem; background-color: rgba(0,0,0,0.7); border-radius: 0.25rem;
      }
      .animated-checkbox-label input[type="checkbox"] { opacity: 0; width: 0; height: 0; }
      .animated-checkbox-label .checkbox-icon { width: 0.875rem; height: 0.875rem; stroke: #a5b4fc; stroke-width: 2; fill: none; }
      .animated-checkbox-label input[type="checkbox"]:checked + .checkbox-icon { stroke: #6ee7b7; }

      body.drop-zone-active { outline: 3px dashed #3b82f6; outline-offset: -3px; }
      .sortable-ghost { opacity: 0.4; background-color: #93c5fd; border-radius: 0.5rem; }
      .sortable-chosen { transform: scale(1.02); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
      footer { position: sticky; bottom: 0; left: 0; right: 0; z-index: 50; }
      #footer-drop-zone { border: 2px dashed #4b5563; padding: 1rem; margin-top: 1rem; text-align: center; color: #d1d5db; border-radius: 0.375rem; transition: background-color 0.2s ease, border-color 0.2s ease; }
      #footer-drop-zone.footer-drop-zone-active { background-color: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #eff6ff; }
      #file-input, #import-file-input { display: none; }
      #message-box { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 1000; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; opacity: 0; pointer-events: none; }
      #message-box.show { opacity: 1; transform: translateX(-50%) translateY(0); }
      #message-box.hide { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
      .toggle-switch input { display:none; }
      .toggle-switch input:disabled + .toggle-slider { cursor: not-allowed; background-color: #9ca3af; }
      .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
      .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .toggle-slider { background-color: #2563eb; }
      input:checked + .toggle-slider:before { transform: translateX(20px); }
      .download-link-button { display: inline-block; background-color: #3b82f6; color: white; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.25rem; text-decoration: none; transition: background-color 0.2s ease; }
      .download-link-button:hover { background-color: #1d4ed8; }
      .prompt-button.has-prompt { color: #6ee7b7 !important; }
      .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 199; }
      .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); z-index: 200; width: 90%; max-width: 500px; color: #1f2937; }
      .modal-content h3 { margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600; }
      .modal-textarea { width: 100%; min-height: 100px; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; resize: vertical; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }
      .scene-drop-zone { border: 2px dashed #cbd5e1; padding: 2rem; margin-top: 1rem; text-align: center; color: #9ca3af; border-radius: 0.375rem; transition: background-color 0.2s ease, border-color 0.2s ease; cursor: pointer; }
      .scene-drop-zone.scene-drop-zone-active { background-color: rgba(59, 130, 246, 0.1); border-color: #3b82f6; color: #3b82f6; }

      /* Slideshow Styles */
      #slideshow-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.85); z-index: 250; 
        flex-direction: column; align-items: center; justify-content: center;
        padding: 1rem; box-sizing: border-box;
      }
      #slideshow-content {
        position: relative; display: flex; flex-direction: column;
        width: 100%; height: 100%; 
        max-width: 95vw; max-height: 95vh; 
        background-color: #1f2937; 
        border-radius: 0.5rem;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        overflow: hidden; 
      }
      #slideshow-prompt-overlay { /* MOVED TO TOP */
        position: absolute; top: 0; left: 0; right: 0; /* Changed from bottom: 0 */
        background-color: rgba(0,0,0,0.7); color: white;
        padding: 0.75rem 1rem; font-size: 0.875rem;
        max-height: 25%; /* Adjust max-height if needed */
        overflow-y: auto;
        opacity: 0; transition: opacity 0.3s ease;
        z-index: 10; 
        border-bottom: 1px solid #4b5563; /* Optional: add a separator */
      }
      #slideshow-image-container {
        flex-grow: 1; display: flex; align-items: center; justify-content: center;
        overflow: hidden; padding: 1rem; 
        margin-top: 0; /* Reset margin if prompt was pushing it down */
      }
      /* Adjust if prompt overlay at top affects image container height */
      #slideshow-prompt-overlay.visible + #slideshow-image-container {
        /* Consider if image container needs margin-top if prompt is tall */
      }
      #slideshow-image {
        max-width: 100%; max-height: 100%; 
        object-fit: contain; display: block;
      }
      #slideshow-prompt-overlay.visible { opacity: 1; }
      #slideshow-controls {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.5rem 1rem; background-color: #374151; 
        /* border-top: 1px solid #4b5563; /* No longer needed if prompt is at top */
        width: 100%; 
        box-sizing: border-box;
        flex-shrink: 0; 
      }
      .slideshow-nav-button, #slideshow-autoplay-button, #slideshow-close-button {
        background-color: #4b5563; color: white;
        border: none; padding: 0.5rem 0.75rem; border-radius: 0.375rem;
        cursor: pointer; font-size: 1.25rem; line-height: 1;
      }
      .slideshow-nav-button:hover, #slideshow-autoplay-button:hover, #slideshow-close-button:hover { background-color: #6b7280; }
      #slideshow-indicator { color: #d1d5db; font-size: 0.875rem; text-align: center; flex-grow: 1;}
      #slideshow-close-button { 
        position: absolute; top: 0.75rem; right: 0.75rem; z-index: 20; 
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png" />
    <input type="file" id="import-file-input" accept=".json" />

    <main class="flex-grow p-4 md:p-8">
      <div class="mb-6 px-4 md:px-0 flex justify-between items-center">
        <div>
            <label for="project-title" class="block text-sm font-medium text-gray-700 mb-1">Project Title</label>
            <input type="text" id="project-title-input" value="Untitled Project" class="w-auto min-w-[300px] p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg">
        </div>
        <div class="flex gap-2">
            <button id="view-slideshow-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                View Slideshow
            </button>
            <button id="add-scene-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                Add New Scene
            </button>
        </div>
      </div>

      <div id="scenes-container"></div>
      <div id="initial-drop-instructions" class="text-center p-10 border-2 border-dashed border-gray-300 rounded-lg my-8 bg-white cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors duration-200">
        <p class="text-gray-600">Add a scene first, or drag & drop JPG/PNG images here to create a new scene with them.</p>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mt-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
      </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 shadow-inner mt-auto">
      <div class="container mx-auto flex flex-col">
        <div class="flex flex-wrap justify-between items-center gap-x-6 gap-y-4 w-full">
          <div><span>Total Images: </span><span id="image-count" class="font-bold">0</span><span class="ml-4">Total Scenes: </span><span id="scene-count" class="font-bold">0</span></div>
          <div class="flex items-center gap-2 text-sm"><span>Original Ratio</span><label class="toggle-switch"><input type="checkbox" id="aspect-toggle" /><span class="toggle-slider"></span></label><span>Square Grid</span></div>
          <div class="flex items-center gap-2 text-sm"><label class="toggle-switch"><input type="checkbox" id="hide-empty-prompt-toggle" disabled /><span class="toggle-slider"></span></label><span class="whitespace-nowrap">Hide images without prompt</span></div>
          <div class="flex flex-wrap gap-2 items-center order-first sm:order-none ml-auto sm:ml-0">
            <button id="import-state-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded transition-colors duration-200 text-sm">Load Project</button>
            <button id="save-state-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded transition-colors duration-200 text-sm">Save Project</button>
            <button id="generate-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>Generate ZIP</button>
            <div id="download-link-placeholder"></div>
          </div>
        </div>
        <div id="footer-drop-zone" class="w-full mt-4">Drop more JPG/PNG images here (adds to last scene)</div>
      </div>
    </footer>

    <div id="modal-overlay" class="modal-overlay hidden"></div>
    <div id="prompt-modal" class="modal-content hidden">
      <h3 id="prompt-modal-title">Edit Prompt for Image #</h3>
      <textarea id="prompt-textarea" class="modal-textarea" placeholder="Enter prompt here..."></textarea>
      <div class="modal-actions">
        <button id="copy-prompt-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-auto">Copy Prompt</button>
        <button id="cancel-prompt-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
        <button id="save-prompt-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save Prompt</button>
      </div>
    </div>
    <div id="scene-notes-modal" class="modal-content hidden">
      <h3 id="scene-notes-modal-title">Edit Notes for Scene</h3>
      <textarea id="scene-notes-textarea-modal" class="modal-textarea" placeholder="Enter scene notes here..."></textarea>
      <div class="modal-actions">
        <button id="cancel-scene-notes-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
        <button id="save-scene-notes-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save Notes</button>
      </div>
    </div>
    <div id="message-box" class="bg-red-500 text-white p-3 rounded-md shadow-md"><span id="message-text"></span></div>

    <div id="slideshow-modal" style="display: none;"> 
      <button id="slideshow-close-button" title="Close Slideshow (Esc)">&times;</button>
      <div id="slideshow-content">
        <div id="slideshow-prompt-overlay"></div> <div id="slideshow-image-container">
          <img id="slideshow-image" src="" alt="Slideshow Image" />
        </div>
         <div id="slideshow-controls">
            <button id="slideshow-prev-button" class="slideshow-nav-button">&lt;</button>
            <div class="flex items-center gap-4">
                <span id="slideshow-indicator"></span>
                <button id="slideshow-autoplay-button" title="Play/Pause Autoplay">▶</button>
            </div>
            <button id="slideshow-next-button" class="slideshow-nav-button">&gt;</button>
        </div>
      </div>
    </div>


    <script>
    // --- MODULE: Configuration ---
    const CONFIG = { /* Unchanged */ ACCEPTED_FILE_EXTENSIONS: ["jpg", "jpeg", "png"], FILENAME_PADDING: 3, PROJECT_FILE_EXTENSION: ".storyboard.json", SLIDESHOW_AUTOPLAY_INTERVAL: 3000 };

    // --- MODULE: DOM Elements ---
    const DOM = { /* Unchanged */ fileInput: document.getElementById("file-input"), scenesContainer: document.getElementById("scenes-container"), imageCountSpan: document.getElementById("image-count"), sceneCountSpan: document.getElementById("scene-count"), generateButton: document.getElementById("generate-button"), downloadLinkPlaceholder: document.getElementById("download-link-placeholder"), initialDropInstructions: document.getElementById("initial-drop-instructions"), body: document.body, messageBox: document.getElementById("message-box"), messageText: document.getElementById("message-text"), aspectToggle: document.getElementById("aspect-toggle"), footerDropZone: document.getElementById("footer-drop-zone"), hideEmptyPromptToggle: document.getElementById("hide-empty-prompt-toggle"), modalOverlay: document.getElementById("modal-overlay"), promptModal: document.getElementById("prompt-modal"), promptModalTitle: document.getElementById("prompt-modal-title"), promptTextarea: document.getElementById("prompt-textarea"), savePromptButton: document.getElementById("save-prompt-button"), cancelPromptButton: document.getElementById("cancel-prompt-button"), copyPromptButton: document.getElementById("copy-prompt-button"), sceneNotesModal: document.getElementById("scene-notes-modal"), sceneNotesModalTitle: document.getElementById("scene-notes-modal-title"), sceneNotesTextareaModal: document.getElementById("scene-notes-textarea-modal"), saveSceneNotesButton: document.getElementById("save-scene-notes-button"), cancelSceneNotesButton: document.getElementById("cancel-scene-notes-button"), projectTitleInput: document.getElementById("project-title-input"), saveStateButton: document.getElementById("save-state-button"), importStateButton: document.getElementById("import-state-button"), importFileInput: document.getElementById("import-file-input"), addSceneButton: document.getElementById("add-scene-button"), viewSlideshowButton: document.getElementById("view-slideshow-button"), slideshowModal: document.getElementById("slideshow-modal"), slideshowImage: document.getElementById("slideshow-image"), slideshowPromptOverlay: document.getElementById("slideshow-prompt-overlay"), slideshowIndicator: document.getElementById("slideshow-indicator"), slideshowPrevButton: document.getElementById("slideshow-prev-button"), slideshowNextButton: document.getElementById("slideshow-next-button"), slideshowAutoplayButton: document.getElementById("slideshow-autoplay-button"), slideshowCloseButton: document.getElementById("slideshow-close-button") };

    // --- MODULE: State ---
    const AppState = { /* Unchanged */ scenes: [], nextSceneId: 0, nextImageId: 0, useSquareGrid: false, hideImagesWithoutPrompt: false, currentEditingImage: { sceneId: null, imageId: null }, currentEditingSceneNotesId: null, projectTitle: "Untitled Project", slideshowImages: [], currentSlideshowIndex: 0, slideshowAutoplayTimer: null };

    // --- MODULE: Utility Functions ---
    const Utils = { /* Unchanged */ showMessage(text, type = "error", duration = 3000) { DOM.messageText.textContent = text; DOM.messageBox.classList.remove("bg-red-500", "bg-green-500", "bg-blue-500"); if (type === "success") DOM.messageBox.classList.add("bg-green-500"); else if (type === "info") DOM.messageBox.classList.add("bg-blue-500"); else DOM.messageBox.classList.add("bg-red-500"); DOM.messageBox.classList.remove("hide"); DOM.messageBox.classList.add("show"); setTimeout(() => { DOM.messageBox.classList.remove("show"); DOM.messageBox.classList.add("hide"); }, duration); }, getFileExtension(filename) { return filename.slice(((filename.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase(); }, readFileAsDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = (error) => reject(error); reader.readAsDataURL(file); }); }, getFileSignature(file) { return `${file.name}|${file.size}|${file.lastModified}`; }, async dataURLtoBlob(dataurl) { try { const response = await fetch(dataurl); if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`); return await response.blob(); } catch (e) { console.error("Error converting dataURL to Blob:", e); Utils.showMessage(`Error processing image data: ${e.message}`); return null; } } };

    // --- MODULE: Clipboard Operations ---
    const ClipboardOps = { /* Unchanged */ async copyImageToClipboard(dataURL, imageType = 'image/png') { if (!navigator.clipboard || !navigator.clipboard.write) { Utils.showMessage("Clipboard API not available. You can try right-clicking the image to copy.", "error", 5000); return false; } DOM.body.focus(); let success = false; let errorMessage = ""; try { const blob = await Utils.dataURLtoBlob(dataURL); if (!blob) throw new Error("Failed to convert image to blob for clipboard."); const typeForClipboard = blob.type && ['image/png', 'image/jpeg', 'image/gif', 'image/webp'].includes(blob.type) ? blob.type : 'image/png'; const clipboardItem = new ClipboardItem({ [typeForClipboard]: blob }); await navigator.clipboard.write([clipboardItem]); success = true; } catch (error) { console.error("Failed to copy image to clipboard:", error); if (error.name === 'NotAllowedError') { errorMessage = "Clipboard write not allowed. Try right-clicking the image to copy, or ensure the page is focused and try again."; } else { errorMessage = `Error copying image: ${error.message}. You can try right-clicking the image to copy.`; } } if (success) { Utils.showMessage("Image copied to clipboard!", "success"); return true; } else { Utils.showMessage(errorMessage || "Failed to copy image. You can try right-clicking the image to copy.", "error", 7000); return false; } }, async copyTextToClipboard(text) { if (!navigator.clipboard || !navigator.clipboard.writeText) { Utils.showMessage("Clipboard API not available or not permitted.", "error"); return false; } DOM.body.focus(); let success = false; let errorMessage = ""; try { await navigator.clipboard.writeText(text); success = true; } catch (error) { console.error("Failed to copy text to clipboard:", error); if (error.name === 'NotAllowedError') { errorMessage = "Clipboard write not allowed. Ensure the page is focused and try again."; } else { errorMessage = `Error copying text: ${error.message}`; } } if (success) { Utils.showMessage("Text copied to clipboard!", "success"); return true; } else { Utils.showMessage(errorMessage || "Failed to copy text.", "error", 5000); return false; } } };

    // --- MODULE: Core Application Logic (Scenes, Images) ---
    const CoreLogic = { /* Unchanged */ clearDownloadLink() { const existingLink = DOM.downloadLinkPlaceholder.querySelector("a"); if (existingLink && existingLink.href.startsWith("blob:")) { URL.revokeObjectURL(existingLink.href); } DOM.downloadLinkPlaceholder.innerHTML = ""; }, addNewScene(name = `Scene ${AppState.scenes.length + 1}`, notes = "", images = []) { const newScene = { id: AppState.nextSceneId++, name: name, notes: notes, images: images }; AppState.scenes.push(newScene); RenderModule.renderApp(); return newScene; }, deleteScene(sceneId) { AppState.scenes = AppState.scenes.filter(scene => scene.id !== sceneId); if (AppState.scenes.length === 0) AppState.nextSceneId = 0; RenderModule.renderApp(); }, moveScene(sceneId, direction) { const sceneIndex = AppState.scenes.findIndex(s => s.id === sceneId); if (sceneIndex === -1) return; if (direction === 'up' && sceneIndex > 0) { [AppState.scenes[sceneIndex - 1], AppState.scenes[sceneIndex]] = [AppState.scenes[sceneIndex], AppState.scenes[sceneIndex - 1]]; } else if (direction === 'down' && sceneIndex < AppState.scenes.length - 1) { [AppState.scenes[sceneIndex + 1], AppState.scenes[sceneIndex]] = [AppState.scenes[sceneIndex], AppState.scenes[sceneIndex + 1]]; } RenderModule.renderApp(); }, removeImage(sceneId, imageId) { const scene = AppState.scenes.find(s => s.id === sceneId); if (scene) { scene.images = scene.images.filter(img => img.id !== imageId); CoreLogic.updateAllDuplicateFlags(); RenderModule.renderApp(); } }, updateAllDuplicateFlags() { const allImages = AppState.scenes.flatMap(scene => scene.images); const fileSignatureCounts = new Map(); allImages.forEach(imgData => { if (imgData.file && typeof imgData.file.name === 'string' && typeof imgData.file.size === 'number' && typeof imgData.file.lastModified === 'number') { const signature = Utils.getFileSignature(imgData.file); fileSignatureCounts.set(signature, (fileSignatureCounts.get(signature) || 0) + 1); } }); allImages.forEach(imgData => { if (imgData.file && typeof imgData.file.name === 'string' && typeof imgData.file.size === 'number' && typeof imgData.file.lastModified === 'number') { const signature = Utils.getFileSignature(imgData.file); imgData.isDuplicate = (fileSignatureCounts.get(signature) || 0) > 1; } else { imgData.isDuplicate = false; } }); } };

    // --- MODULE: Modal Management (Prompt & Scene Notes) ---
    const ModalModule = { /* Unchanged */ openPromptModal(sceneId, imageId, displayIndex) { const scene = AppState.scenes.find(s => s.id === sceneId); if (!scene) return; const image = scene.images.find(img => img.id === imageId); if (!image) return; AppState.currentEditingImage = { sceneId, imageId }; DOM.promptModalTitle.textContent = `Edit Prompt for Image ${displayIndex}`; DOM.promptTextarea.value = image.prompt || ""; DOM.modalOverlay.classList.remove("hidden"); DOM.promptModal.classList.remove("hidden"); DOM.promptTextarea.focus(); }, closePromptModal() { DOM.modalOverlay.classList.add("hidden"); DOM.promptModal.classList.add("hidden"); DOM.promptTextarea.value = ""; AppState.currentEditingImage = { sceneId: null, imageId: null }; }, savePrompt() { const { sceneId, imageId } = AppState.currentEditingImage; if (sceneId === null || imageId === null) return; const scene = AppState.scenes.find(s => s.id === sceneId); if (!scene) return; const image = scene.images.find(img => img.id === imageId); if (!image) return; image.prompt = DOM.promptTextarea.value.trim(); ModalModule.closePromptModal(); RenderModule.renderApp(); }, openSceneNotesModal(sceneId) { const scene = AppState.scenes.find(s => s.id === sceneId); if (!scene) return; AppState.currentEditingSceneNotesId = sceneId; DOM.sceneNotesModalTitle.textContent = `Edit Notes for ${scene.name}`; DOM.sceneNotesTextareaModal.value = scene.notes || ""; DOM.modalOverlay.classList.remove("hidden"); DOM.sceneNotesModal.classList.remove("hidden"); DOM.sceneNotesTextareaModal.focus(); }, closeSceneNotesModal() { DOM.modalOverlay.classList.add("hidden"); DOM.sceneNotesModal.classList.add("hidden"); DOM.sceneNotesTextareaModal.value = ""; AppState.currentEditingSceneNotesId = null; }, saveSceneNotes() { if (AppState.currentEditingSceneNotesId === null) return; const scene = AppState.scenes.find(s => s.id === AppState.currentEditingSceneNotesId); if (scene) { scene.notes = DOM.sceneNotesTextareaModal.value.trim(); } ModalModule.closeSceneNotesModal(); RenderModule.renderApp(); } };

    // --- MODULE: Slideshow ---
    const SlideshowModule = { /* Unchanged (except for DOM.slideshowModal.style.display changes) */ prepareImages() { AppState.slideshowImages = []; AppState.scenes.forEach((scene, sceneIdx) => { scene.images.forEach((imgData, imgIdxInScene) => { AppState.slideshowImages.push({ dataURL: imgData.dataURL, prompt: imgData.prompt || "", sceneName: scene.name || `Scene ${sceneIdx + 1}`, sceneIndexGlobal: sceneIdx + 1, imageIndexInScene: imgIdxInScene + 1 }); }); }); }, displayCurrent() { if (AppState.slideshowImages.length === 0 || AppState.currentSlideshowIndex < 0 || AppState.currentSlideshowIndex >= AppState.slideshowImages.length) { SlideshowModule.close(); return; } const currentImage = AppState.slideshowImages[AppState.currentSlideshowIndex]; DOM.slideshowImage.src = currentImage.dataURL; DOM.slideshowImage.alt = `${currentImage.sceneName} - Image ${currentImage.imageIndexInScene}`; if (currentImage.prompt) { DOM.slideshowPromptOverlay.textContent = currentImage.prompt; DOM.slideshowPromptOverlay.classList.add('visible'); } else { DOM.slideshowPromptOverlay.textContent = ''; DOM.slideshowPromptOverlay.classList.remove('visible'); } const sceneForIndicator = AppState.scenes[currentImage.sceneIndexGlobal-1]; const totalImagesInScene = sceneForIndicator ? sceneForIndicator.images.length : 0; DOM.slideshowIndicator.textContent = `${currentImage.sceneName} (Image ${currentImage.imageIndexInScene} of ${totalImagesInScene}) - Overall ${AppState.currentSlideshowIndex + 1} of ${AppState.slideshowImages.length}`; }, open(startIndex = 0) { SlideshowModule.prepareImages(); if (AppState.slideshowImages.length === 0) { Utils.showMessage("No images to display in slideshow.", "info"); return; } AppState.currentSlideshowIndex = Math.max(0, Math.min(startIndex, AppState.slideshowImages.length - 1)); SlideshowModule.displayCurrent(); DOM.slideshowModal.style.display = 'flex'; document.addEventListener('keydown', SlideshowModule.handleKeydown); }, close() { DOM.slideshowModal.style.display = 'none'; SlideshowModule.stopAutoplay(); document.removeEventListener('keydown', SlideshowModule.handleKeydown); }, next() { AppState.currentSlideshowIndex = (AppState.currentSlideshowIndex + 1) % AppState.slideshowImages.length; SlideshowModule.displayCurrent(); }, prev() { AppState.currentSlideshowIndex = (AppState.currentSlideshowIndex - 1 + AppState.slideshowImages.length) % AppState.slideshowImages.length; SlideshowModule.displayCurrent(); }, toggleAutoplay() { if (AppState.slideshowAutoplayTimer) { SlideshowModule.stopAutoplay(); } else { SlideshowModule.startAutoplay(); } }, startAutoplay() { SlideshowModule.stopAutoplay(); DOM.slideshowAutoplayButton.textContent = '❚❚'; DOM.slideshowAutoplayButton.title = "Pause Autoplay"; AppState.slideshowAutoplayTimer = setInterval(SlideshowModule.next, CONFIG.SLIDESHOW_AUTOPLAY_INTERVAL); }, stopAutoplay() { clearInterval(AppState.slideshowAutoplayTimer); AppState.slideshowAutoplayTimer = null; DOM.slideshowAutoplayButton.textContent = '▶'; DOM.slideshowAutoplayButton.title = "Play Autoplay"; }, handleKeydown(event) { if (event.key === 'Escape') SlideshowModule.close(); else if (event.key === 'ArrowRight') SlideshowModule.next(); else if (event.key === 'ArrowLeft') SlideshowModule.prev(); else if (event.key === ' ') { event.preventDefault(); SlideshowModule.toggleAutoplay(); } } };
    
    // --- MODULE: Main Rendering ---
    const RenderModule = { /* Unchanged */ renderApp() { DOM.scenesContainer.innerHTML = ""; DOM.projectTitleInput.value = AppState.projectTitle; let totalImageCount = 0; DOM.initialDropInstructions.classList.toggle('hidden', AppState.scenes.length > 0); AppState.scenes.forEach((scene, sceneIndex) => { totalImageCount += scene.images.length; const sceneBlock = document.createElement("div"); sceneBlock.classList.add("scene-block"); sceneBlock.dataset.sceneId = scene.id; const sceneHeader = document.createElement("div"); sceneHeader.classList.add("scene-header"); const sceneTitleInputEl = document.createElement("input"); sceneTitleInputEl.type = "text"; sceneTitleInputEl.value = scene.name; sceneTitleInputEl.placeholder = "Scene Name"; sceneTitleInputEl.classList.add("scene-title-input"); sceneTitleInputEl.addEventListener("change", (e) => { scene.name = e.target.value.trim() || `Scene ${sceneIndex + 1}`; e.target.value = scene.name; }); sceneHeader.appendChild(sceneTitleInputEl); const sceneControlsDiv = document.createElement("div"); sceneControlsDiv.classList.add("flex", "gap-2", "items-center", "scene-actions"); const notesButton = document.createElement("button"); notesButton.classList.add("scene-notes-button"); notesButton.textContent = scene.notes && scene.notes.trim() !== "" ? "View/Edit Notes" : "Add Notes"; if (scene.notes && scene.notes.trim() !== "") notesButton.classList.add("has-notes"); notesButton.addEventListener("click", () => ModalModule.openSceneNotesModal(scene.id)); sceneControlsDiv.appendChild(notesButton); const moveUpBtn = document.createElement("button"); moveUpBtn.textContent = "↑ Up"; moveUpBtn.classList.add("scene-move-button"); moveUpBtn.disabled = sceneIndex === 0; moveUpBtn.addEventListener("click", () => CoreLogic.moveScene(scene.id, 'up')); sceneControlsDiv.appendChild(moveUpBtn); const moveDownBtn = document.createElement("button"); moveDownBtn.textContent = "↓ Down"; moveDownBtn.classList.add("scene-move-button"); moveDownBtn.disabled = sceneIndex === AppState.scenes.length - 1; moveDownBtn.addEventListener("click", () => CoreLogic.moveScene(scene.id, 'down')); sceneControlsDiv.appendChild(moveDownBtn); const deleteSceneBtn = document.createElement("button"); deleteSceneBtn.textContent = "Delete Scene"; deleteSceneBtn.classList.add("delete-scene-button"); deleteSceneBtn.addEventListener("click", () => CoreLogic.deleteScene(scene.id)); sceneControlsDiv.appendChild(deleteSceneBtn); sceneHeader.appendChild(sceneControlsDiv); sceneBlock.appendChild(sceneHeader); const imageGridDiv = document.createElement("div"); imageGridDiv.classList.add("grid", "scene-image-grid"); imageGridDiv.dataset.sceneGridId = scene.id; const imagesToDisplay = AppState.hideImagesWithoutPrompt ? scene.images.filter(img => img.prompt && img.prompt.trim() !== "") : scene.images; if (imagesToDisplay.length === 0) { imageGridDiv.classList.add('empty-scene-image-grid'); } else { imageGridDiv.classList.remove('empty-scene-image-grid'); } imagesToDisplay.forEach((imgData) => { const originalImgIndexInScene = scene.images.findIndex(originalImg => originalImg.id === imgData.id); const div = document.createElement("div"); div.classList.add("image-item"); if (imgData.isAnimated) div.classList.add("is-animated"); if (AppState.useSquareGrid) div.classList.add("aspect-square"); div.dataset.id = imgData.id; div.dataset.sourceSceneId = scene.id; const imgElement = document.createElement("img"); imgElement.src = imgData.dataURL; imgElement.alt = `S${sceneIndex + 1}-Img ${originalImgIndexInScene + 1}`; imgElement.loading = "lazy"; imgElement.onerror = function() { this.alt = `Error S${sceneIndex+1}-I${originalImgIndexInScene+1}`; this.src = `https://placehold.co/200x200/f0f0f0/999999?text=Error`; div.style.backgroundColor = "#fee2e2"; }; const overlayContainer = document.createElement("div"); overlayContainer.classList.add("image-overlay-bottom", "pointer-events-auto", "flex", "items-center", "gap-1"); const indexSpan = document.createElement("span"); indexSpan.classList.add("image-index"); indexSpan.textContent = `${sceneIndex + 1}-${originalImgIndexInScene + 1}`; if (imgData.isDuplicate) indexSpan.classList.add("image-index-duplicate"); overlayContainer.appendChild(indexSpan); if (imgData.isDuplicate) { const dupe = document.createElement("span"); dupe.classList.add("duplicate-tag"); dupe.textContent="DUPE"; overlayContainer.appendChild(dupe); } const animatedLabel = document.createElement('label'); animatedLabel.classList.add('animated-checkbox-label'); animatedLabel.title = "Mark as animated"; const animatedCheckbox = document.createElement('input'); animatedCheckbox.type = 'checkbox'; animatedCheckbox.checked = imgData.isAnimated || false; animatedCheckbox.addEventListener('change', (e) => { imgData.isAnimated = e.target.checked; div.classList.toggle('is-animated', imgData.isAnimated); }); const checkboxSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); checkboxSVG.setAttribute('class', 'checkbox-icon'); checkboxSVG.setAttribute('viewBox', '0 0 24 24'); checkboxSVG.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`; animatedLabel.appendChild(animatedCheckbox); animatedLabel.appendChild(checkboxSVG); overlayContainer.appendChild(animatedLabel); const copyImgBtn = document.createElement("button"); copyImgBtn.classList.add("image-action-button"); copyImgBtn.title = "Copy Image to Clipboard"; copyImgBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`; copyImgBtn.addEventListener("click", (e) => { e.stopPropagation(); ClipboardOps.copyImageToClipboard(imgData.dataURL, imgData.file?.type); }); overlayContainer.appendChild(copyImgBtn); const promptBtn = document.createElement("button"); promptBtn.classList.add("image-action-button", "prompt-button"); promptBtn.title = "Edit Prompt"; promptBtn.dataset.imageId = imgData.id; promptBtn.dataset.sceneId = scene.id; promptBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`; if (imgData.prompt && imgData.prompt.trim() !== "") promptBtn.classList.add("has-prompt"); promptBtn.addEventListener("click", (e) => { e.stopPropagation(); ModalModule.openPromptModal(scene.id, imgData.id, `${sceneIndex + 1}-${originalImgIndexInScene + 1}`); }); overlayContainer.appendChild(promptBtn); const removeBtn = document.createElement("button"); removeBtn.classList.add("remove-button"); removeBtn.title = "Remove Image"; removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`; removeBtn.addEventListener("click", (e) => { e.stopPropagation(); CoreLogic.removeImage(scene.id, imgData.id); }); div.appendChild(imgElement); div.appendChild(overlayContainer); div.appendChild(removeBtn); imageGridDiv.appendChild(div); }); sceneBlock.appendChild(imageGridDiv); const sceneDropZoneEl = document.createElement('div'); sceneDropZoneEl.classList.add('scene-drop-zone'); sceneDropZoneEl.textContent = 'Drag & drop images here or click to add to this scene'; sceneDropZoneEl.dataset.sceneId = scene.id; sceneDropZoneEl.addEventListener('click', (e) => { const sId = parseInt(e.currentTarget.dataset.sceneId); DOM.fileInput.dataset.targetSceneId = sId; DOM.fileInput.click(); }); sceneDropZoneEl.addEventListener('dragover', DragDropModule.handleDragOverScene); sceneDropZoneEl.addEventListener('dragleave', DragDropModule.handleDragLeaveScene); sceneDropZoneEl.addEventListener('drop', (e) => DragDropModule.handleDropOnScene(e, scene.id)); sceneBlock.appendChild(sceneDropZoneEl); DOM.scenesContainer.appendChild(sceneBlock); new Sortable(imageGridDiv, { group: 'scene-images', animation: 150, ghostClass: "sortable-ghost", chosenClass: "sortable-chosen", filter: ".remove-button, .prompt-button, .image-action-button, .animated-checkbox-label", preventOnFilter: true, onEnd: (evt) => { const movedImageId = parseInt(evt.item.dataset.id); const fromSceneId = parseInt(evt.from.dataset.sceneGridId); const toSceneId = parseInt(evt.to.dataset.sceneGridId); const oldIndexInFromScene = evt.oldDraggableIndex; const newIndexInToScene = evt.newDraggableIndex; const fromScene = AppState.scenes.find(s => s.id === fromSceneId); const toScene = AppState.scenes.find(s => s.id === toSceneId); if (!fromScene || !toScene) { console.error("Scene not found for drag/drop"); RenderModule.renderApp(); return; } let movedItemData; let actualOldIndex; if (AppState.hideImagesWithoutPrompt) { let visibleIdx = 0; for(let i=0; i<fromScene.images.length; i++) { if((fromScene.images[i].prompt && fromScene.images[i].prompt.trim() !== "") || fromScene.images[i].id === movedImageId) { if(visibleIdx === oldIndexInFromScene) { actualOldIndex = i; break; } visibleIdx++; } } if (actualOldIndex === undefined) actualOldIndex = fromScene.images.findIndex(img => img.id === movedImageId); } else { actualOldIndex = oldIndexInFromScene; } if (actualOldIndex === undefined || actualOldIndex < 0) { console.error("Moved item not found in source by index."); RenderModule.renderApp(); return; } movedItemData = fromScene.images[actualOldIndex]; if (!movedItemData || movedItemData.id !== movedImageId) { movedItemData = fromScene.images.find(img => img.id === movedImageId); actualOldIndex = fromScene.images.findIndex(img => img.id === movedImageId); if (!movedItemData) { console.error("Moved item data mismatch."); RenderModule.renderApp(); return; }} fromScene.images.splice(actualOldIndex, 1); if (AppState.hideImagesWithoutPrompt) { let visibleCount = 0; let actualNewIndex = -1; for (let i = 0; i <= toScene.images.length; i++) { if (visibleCount === newIndexInToScene) { actualNewIndex = i; break; } if (i < toScene.images.length && (toScene.images[i].prompt && toScene.images[i].prompt.trim() !== "")) { visibleCount++; } else if (i === toScene.images.length) { actualNewIndex = i; break; } } if (actualNewIndex === -1) actualNewIndex = toScene.images.length; toScene.images.splice(actualNewIndex, 0, movedItemData); } else { toScene.images.splice(newIndexInToScene, 0, movedItemData); } CoreLogic.updateAllDuplicateFlags(); RenderModule.renderApp(); }, }); }); DOM.imageCountSpan.textContent = totalImageCount; DOM.sceneCountSpan.textContent = AppState.scenes.length; DOM.generateButton.disabled = totalImageCount === 0; DOM.saveStateButton.disabled = AppState.scenes.length === 0 && AppState.projectTitle === "Untitled Project"; DOM.hideEmptyPromptToggle.disabled = totalImageCount === 0; DOM.viewSlideshowButton.disabled = totalImageCount === 0; CoreLogic.clearDownloadLink(); } };
    
    // --- MODULE: File Processing & Upload ---
    const FileProcessing = { /* Unchanged */ async processFiles(fileList, targetSceneId = null) { const validImageFiles = Array.from(fileList).filter(file => { return file.type.startsWith("image/") && CONFIG.ACCEPTED_FILE_EXTENSIONS.includes(Utils.getFileExtension(file.name));}); if (validImageFiles.length === 0 && fileList.length > 0) { Utils.showMessage("No valid image files found."); return; } let sceneToAddTo; if (targetSceneId !== null) { sceneToAddTo = AppState.scenes.find(s => s.id === targetSceneId); } else if (AppState.scenes.length > 0) { sceneToAddTo = AppState.scenes[AppState.scenes.length - 1]; } else { sceneToAddTo = CoreLogic.addNewScene(); } if (!sceneToAddTo) { Utils.showMessage("Could not find a scene to add images to.", "error"); return; } Utils.showMessage(`Processing ${validImageFiles.length} images for scene "${sceneToAddTo.name}"...`, "info"); const newImageDataObjects = []; try { const readPromises = validImageFiles.map(file => Utils.readFileAsDataURL(file).then(dataURL => ({ id: AppState.nextImageId++, file: file, dataURL: dataURL, prompt: "", isDuplicate: false, isAnimated: false })).catch(e => { console.error(e); Utils.showMessage(`Error reading ${file.name}`); return null; })); const results = await Promise.all(readPromises); newImageDataObjects.push(...results.filter(r => r !== null)); } catch (e) { console.error(e); Utils.showMessage("Error processing files."); } sceneToAddTo.images.push(...newImageDataObjects); CoreLogic.updateAllDuplicateFlags(); RenderModule.renderApp(); } };

    // --- MODULE: Project State (Save/Load) ---
    const ProjectState = { /* Unchanged */ saveToFile() { if (AppState.scenes.length === 0 && AppState.projectTitle === "Untitled Project") { Utils.showMessage("Nothing to save.", "info"); return; } const scenesToSave = AppState.scenes.map(scene => ({ ...scene, images: scene.images.map(imgData => ({ id: imgData.id, file: (imgData.file instanceof File) ? { name: imgData.file.name, type: imgData.file.type, size: imgData.file.size, lastModified: imgData.file.lastModified } : imgData.file, dataURL: imgData.dataURL, prompt: imgData.prompt, isAnimated: imgData.isAnimated || false })) })); const state = { projectTitle: AppState.projectTitle, scenes: scenesToSave, settings: { useSquareGrid: AppState.useSquareGrid, hideImagesWithoutPrompt: AppState.hideImagesWithoutPrompt }, nextSceneId: AppState.nextSceneId, nextImageId: AppState.nextImageId, }; try { const jsonString = JSON.stringify(state, null, 2); const blob = new Blob([jsonString], { type: "application/json" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); const safeProjectTitle = AppState.projectTitle.replace(/[^a-z0-9_.-]/gi, '_').substring(0, 50) || "storyboard_project"; link.download = `${safeProjectTitle}${CONFIG.PROJECT_FILE_EXTENSION}`; DOM.body.appendChild(link); link.click(); DOM.body.removeChild(link); URL.revokeObjectURL(link.href); Utils.showMessage("Project saved successfully!", "success"); } catch (e) { console.error(e); Utils.showMessage(`Error saving project: ${e.message}`); } }, loadFromFile(event) { const file = event.target.files[0]; if (!file) return; if (!file.name.endsWith(CONFIG.PROJECT_FILE_EXTENSION) && file.type !== "application/json") { Utils.showMessage(`Invalid file type. Select '${CONFIG.PROJECT_FILE_EXTENSION}'.`); DOM.importFileInput.value = ""; return; } const reader = new FileReader(); reader.onload = (e) => { try { const state = JSON.parse(e.target.result); if (!state || typeof state !== 'object' || !Array.isArray(state.scenes) || !state.settings || typeof state.nextSceneId !== 'number' || typeof state.nextImageId !== 'number') { throw new Error("Invalid project file format."); } AppState.projectTitle = state.projectTitle || "Untitled Project"; AppState.scenes = state.scenes.map(sceneToLoad => ({ ...sceneToLoad, images: sceneToLoad.images.map(imgToLoad => ({ ...imgToLoad, file: { name: imgToLoad.file.name || `imported_image_${imgToLoad.id}.png`, type: imgToLoad.file.type || 'image/png', size: imgToLoad.file.size || 0, lastModified: imgToLoad.file.lastModified || Date.now() }, isDuplicate: false, isAnimated: imgToLoad.isAnimated || false })) })); AppState.nextSceneId = state.nextSceneId; AppState.nextImageId = state.nextImageId; AppState.useSquareGrid = state.settings.useSquareGrid || false; AppState.hideImagesWithoutPrompt = state.settings.hideImagesWithoutPrompt || false; DOM.aspectToggle.checked = AppState.useSquareGrid; DOM.hideEmptyPromptToggle.checked = AppState.hideImagesWithoutPrompt; CoreLogic.updateAllDuplicateFlags(); RenderModule.renderApp(); Utils.showMessage("Project loaded successfully!", "success"); } catch (err) { console.error(err); Utils.showMessage(`Error loading project: ${err.message}.`); } finally { DOM.importFileInput.value = ""; } }; reader.onerror = () => { Utils.showMessage("Failed to read project file."); DOM.importFileInput.value = ""; }; reader.readAsText(file); } };

    // --- MODULE: ZIP Export ---
    const ZipExport = { /* Unchanged */ async generate() { const allImagesFlat = AppState.scenes.flatMap(scene => scene.images); if (allImagesFlat.length === 0) { Utils.showMessage("No images to generate ZIP."); return; } DOM.generateButton.disabled = true; DOM.generateButton.textContent = "Generating..."; CoreLogic.clearDownloadLink(); try { const zip = new JSZip(); const manifest = { projectTitle: AppState.projectTitle, scenes: [] }; for (let sceneIndex = 0; sceneIndex < AppState.scenes.length; sceneIndex++) { const scene = AppState.scenes[sceneIndex]; const sceneManifestEntry = { sceneId: scene.id, sceneName: scene.name, sceneNotes: scene.notes, images: [] }; for (let imgIndexInScene = 0; imgIndexInScene < scene.images.length; imgIndexInScene++) { const imgData = scene.images[imgIndexInScene]; const fileObject = imgData.file; let fileData; let originalFileName; if (fileObject instanceof File) { fileData = fileObject; originalFileName = fileObject.name; } else if (fileObject && typeof fileObject === 'object' && imgData.dataURL) { fileData = await Utils.dataURLtoBlob(imgData.dataURL); originalFileName = fileObject.name || `image_${imgData.id}.png`; if (!fileData) { console.warn(`Skipping img ${imgData.id} in S${sceneIndex+1} due to blob conversion error.`); continue; } } else { console.warn(`Skipping img ${imgData.id} in S${sceneIndex+1} due to missing data.`); continue; } const extension = Utils.getFileExtension(originalFileName); const sceneNumStr = String(sceneIndex + 1).padStart(CONFIG.FILENAME_PADDING, "0"); const imageNumStr = String(imgIndexInScene + 1).padStart(CONFIG.FILENAME_PADDING, "0"); const filenameInZip = `${sceneNumStr}_${imageNumStr}.${extension}`; zip.file(filenameInZip, fileData); sceneManifestEntry.images.push({ zipFilename: filenameInZip, originalName: originalFileName, prompt: imgData.prompt || "", internalId: imgData.id, isAnimated: imgData.isAnimated || false }); } manifest.scenes.push(sceneManifestEntry); } zip.file("manifest.json", JSON.stringify(manifest, null, 2)); const blob = await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 6 } }); if (blob.size === 0) throw new Error("Generated ZIP is empty."); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.href = url; const safeProjectTitle = AppState.projectTitle.replace(/[^a-z0-9_.-]/gi, '_').substring(0, 50) || "storyboard"; link.download = `${safeProjectTitle}_storyboard.zip`; link.textContent = "Download ZIP"; link.classList.add("download-link-button"); link.addEventListener('click', () => setTimeout(() => URL.revokeObjectURL(url), 150)); DOM.downloadLinkPlaceholder.appendChild(link); Utils.showMessage("ZIP generated successfully!", "success"); } catch (e) { console.error(e); Utils.showMessage(`Error creating ZIP: ${e.message}`); CoreLogic.clearDownloadLink(); } finally { DOM.generateButton.disabled = allImagesFlat.length === 0; DOM.generateButton.textContent = "Generate ZIP"; } } };
    
    // --- MODULE: Drag and Drop Handlers ---
    const DragDropModule = { /* Unchanged */ handleDragOverScene(event) { event.preventDefault(); event.stopPropagation(); event.currentTarget.classList.add('scene-drop-zone-active'); DOM.body.classList.remove("drop-zone-active"); DOM.footerDropZone.classList.remove("footer-drop-zone-active"); DOM.initialDropInstructions.classList.remove("border-blue-500", "bg-blue-50"); }, handleDragLeaveScene(event) { event.preventDefault(); event.stopPropagation(); const rect = event.currentTarget.getBoundingClientRect(); if (event.clientX < rect.left || event.clientX >= rect.right || event.clientY < rect.top || event.clientY >= rect.bottom) { event.currentTarget.classList.remove('scene-drop-zone-active'); } }, handleDropOnScene(event, sceneId) { event.preventDefault(); event.stopPropagation(); event.currentTarget.classList.remove('scene-drop-zone-active'); const files = event.dataTransfer.files; if (files && files.length > 0) { FileProcessing.processFiles(files, sceneId); } }, setupGlobalHandlers() { DOM.initialDropInstructions.addEventListener('click', () => { if (AppState.scenes.length === 0) CoreLogic.addNewScene(); const targetSceneId = AppState.scenes.length > 0 ? AppState.scenes[AppState.scenes.length - 1].id : null; if (targetSceneId !== null) { DOM.fileInput.dataset.targetSceneId = targetSceneId; } else { delete DOM.fileInput.dataset.targetSceneId; } DOM.fileInput.click(); }); DOM.initialDropInstructions.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); DOM.initialDropInstructions.classList.add("border-blue-500","bg-blue-50"); DOM.body.classList.remove("drop-zone-active");}); DOM.initialDropInstructions.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); DOM.initialDropInstructions.classList.remove("border-blue-500","bg-blue-50");}); DOM.initialDropInstructions.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); DOM.initialDropInstructions.classList.remove("border-blue-500","bg-blue-50"); const files = e.dataTransfer.files; if (files && files.length > 0) { let targetScene; if (AppState.scenes.length === 0) { targetScene = CoreLogic.addNewScene("Scene 1 (from drop)"); } else { targetScene = AppState.scenes[AppState.scenes.length -1]; } FileProcessing.processFiles(files, targetScene.id); } }); DOM.body.addEventListener("dragover", (e) => { e.preventDefault(); e.stopPropagation(); if (e.target === DOM.body || !DOM.scenesContainer.contains(e.target) && !document.querySelector("footer").contains(e.target) && e.target !== DOM.initialDropInstructions) DOM.body.classList.add("drop-zone-active"); else DOM.body.classList.remove("drop-zone-active"); }); DOM.body.addEventListener("dragleave", (e) => { if (!e.relatedTarget || !DOM.body.contains(e.relatedTarget)) DOM.body.classList.remove("drop-zone-active"); }); DOM.body.addEventListener("drop", (e) => { e.preventDefault(); e.stopPropagation(); DOM.body.classList.remove("drop-zone-active"); if (e.target === DOM.body) { const files = e.dataTransfer.files; if (files && files.length > 0) { let targetScene; if (AppState.scenes.length === 0) targetScene = CoreLogic.addNewScene("Scene 1 (from body drop)"); else targetScene = AppState.scenes[AppState.scenes.length -1]; FileProcessing.processFiles(files, targetScene.id); } } }); DOM.footerDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); DOM.footerDropZone.classList.add("footer-drop-zone-active"); DOM.body.classList.remove("drop-zone-active"); }); DOM.footerDropZone.addEventListener('dragleave', (e) => { DOM.footerDropZone.classList.remove("footer-drop-zone-active"); }); DOM.footerDropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); DOM.footerDropZone.classList.remove("footer-drop-zone-active"); const files = e.dataTransfer.files; if (files && files.length > 0) { const targetSceneId = AppState.scenes.length > 0 ? AppState.scenes[AppState.scenes.length - 1].id : (CoreLogic.addNewScene("New Scene from Footer Drop")).id; FileProcessing.processFiles(files, targetSceneId); } }); } };
    
    // --- MODULE: Event Listeners Setup ---
    const EventListeners = {
        init() {
            DOM.projectTitleInput.addEventListener("input", (e) => { AppState.projectTitle = e.target.value; DOM.saveStateButton.disabled = AppState.scenes.length === 0 && AppState.projectTitle.trim() === "Untitled Project"; });
            DOM.projectTitleInput.addEventListener("change", (e) => { if(AppState.projectTitle.trim() === "") { AppState.projectTitle = "Untitled Project"; e.target.value = AppState.projectTitle; }});
            DOM.addSceneButton.addEventListener("click", () => CoreLogic.addNewScene());
            DOM.saveStateButton.addEventListener("click", ProjectState.saveToFile);
            DOM.importStateButton.addEventListener("click", () => DOM.importFileInput.click());
            DOM.importFileInput.addEventListener("change", ProjectState.loadFromFile);
            DOM.fileInput.addEventListener("change", (event) => { const targetSceneId = event.target.dataset.targetSceneId ? parseInt(event.target.dataset.targetSceneId) : null; FileProcessing.processFiles(event.target.files, targetSceneId); event.target.value = null; delete event.target.dataset.targetSceneId; });
            DOM.generateButton.addEventListener("click", ZipExport.generate);
            DOM.aspectToggle.addEventListener("change", (e) => { AppState.useSquareGrid = e.target.checked; RenderModule.renderApp(); });
            DOM.hideEmptyPromptToggle.addEventListener("change", (e) => { AppState.hideImagesWithoutPrompt = e.target.checked; RenderModule.renderApp(); });
            
            DOM.savePromptButton.addEventListener("click", ModalModule.savePrompt);
            DOM.cancelPromptButton.addEventListener("click", ModalModule.closePromptModal);
            DOM.copyPromptButton.addEventListener("click", () => { if (DOM.promptTextarea.value) { ClipboardOps.copyTextToClipboard(DOM.promptTextarea.value); } else { Utils.showMessage("Prompt is empty, nothing to copy.", "info"); } });
            DOM.saveSceneNotesButton.addEventListener("click", ModalModule.saveSceneNotes);
            DOM.cancelSceneNotesButton.addEventListener("click", ModalModule.closeSceneNotesModal);
            DOM.modalOverlay.addEventListener("click", () => { 
                ModalModule.closePromptModal(); 
                ModalModule.closeSceneNotesModal(); 
            });

            // Slideshow
            DOM.viewSlideshowButton.addEventListener('click', () => SlideshowModule.open());
            DOM.slideshowCloseButton.addEventListener('click', (e) => {
                e.stopPropagation(); 
                SlideshowModule.close();
            });
            DOM.slideshowPrevButton.addEventListener('click', SlideshowModule.prev);
            DOM.slideshowNextButton.addEventListener('click', SlideshowModule.next);
            DOM.slideshowAutoplayButton.addEventListener('click', SlideshowModule.toggleAutoplay);
            DOM.slideshowModal.addEventListener('click', (event) => {
                if (event.target === DOM.slideshowModal) { 
                    SlideshowModule.close();
                }
            });

            DragDropModule.setupGlobalHandlers();
        }
    };

    // --- MODULE: Application Initialization ---
    const AppInit = {
        run() {
            if (DOM.slideshowModal) {
                 DOM.slideshowModal.style.display = 'none';
            }
            EventListeners.init();
            RenderModule.renderApp(); 
        }
    };

    AppInit.run();

    </script>
  </body>
</html>
